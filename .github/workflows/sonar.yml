name: SonarCloud
on:
  push:
    branches: [ 'main', 'feature/*' ]
    tags: [ v* ]
jobs:
  sonarcloud:
    name: SonarCloud scan
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Check secrets presence
        id: checksecrets
        shell: bash
        run: |
            if [ "$SONAR_TOKEN" == "" ]; then
              echo "secretspresent=NO" >> $GITHUB_OUTPUT
            else
              echo "secretspresent=YES" >> $GITHUB_OUTPUT
              echo "PROJECTKEY=${{ github.repository_owner}}_$(echo ${{ github.repository }} | sed 's/.*\///')" >> $GITHUB_ENV
            fi
        env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN}}
      - name: SonarCloud Action
        if: (steps.checksecrets.outputs.secretspresent == 'YES')
        uses: SonarSource/sonarcloud-github-action@master
        with:
            args: >
                -Dsonar.organization=${{ github.repository_owner }}
                -Dsonar.projectKey=${{ env.PROJECTKEY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}